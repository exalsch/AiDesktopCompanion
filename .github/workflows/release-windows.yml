name: Release Windows Installers

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release-windows:
    name: Build and Release Windows installers
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'app/package-lock.json'

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache Rust (Cargo + target)
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            app/src-tauri
          cache-on-failure: true

      - name: Install WiX Toolset (for MSI bundling)
        run: choco install wixtoolset -y --no-progress

      # Local STT (Whisper) requires LLVM/Clang for bindgen on Windows.
      - name: Install LLVM (libclang) for local-stt
        shell: pwsh
        run: |
          choco install llvm -y --no-progress
          echo "LIBCLANG_PATH=C:\\Program Files\\LLVM\\bin" | Out-File -FilePath $env:GITHUB_ENV -Append

      # (Optional) CMake is commonly needed for audio dependencies
      - name: Ensure CMake (for local-stt)
        run: choco install cmake -y --no-progress

      # - name: Import Windows code signing cert (optional)
      #   if: ${{ secrets.WINDOWS_CERT_PFX_BASE64 != '' && secrets.WINDOWS_CERT_PASSWORD != '' }}
      #   shell: pwsh
      #   run: |
      #     $certPath = "$env:RUNNER_TEMP\\codesign.pfx"
      #     [IO.File]::WriteAllBytes($certPath, [Convert]::FromBase64String($env:WINDOWS_CERT_PFX_BASE64))
      #     echo "CERT_PATH=$certPath" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Install frontend dependencies
        working-directory: app
        run: npm ci

      - name: Build Tauri app (Windows release)
        working-directory: app
        run: npm run tauri -- build

      - name: Generate release notes (Conventional Commits)
        id: changelog
        uses: TriPSs/conventional-changelog-action@v5
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          preset: conventionalcommits
          skip-commit: true
          output-file: false
          tag-prefix: 'v'

      # - name: Code-sign Windows artifacts (optional)
      #   if: env.CERT_PATH != ''
      #   shell: pwsh
      #   run: |
      #     $signtool = (Get-Command signtool.exe -ErrorAction SilentlyContinue).Source
      #     if (-not $signtool) { throw "signtool.exe not found on PATH. Ensure Windows SDK is installed." }
      #     $timestamp = if ('${{ secrets.WINDOWS_TIMESTAMP_URL }}') { '${{ secrets.WINDOWS_TIMESTAMP_URL }}' } else { 'http://timestamp.digicert.com' }
      #     $bundleRoot = "app\src-tauri\target"
      #     $files = Get-ChildItem $bundleRoot -Include *.exe,*.msi -Recurse -File
      #     if ($files.Count -eq 0) { Write-Host "No signable artifacts found under $bundleRoot." }
      #     foreach ($f in $files) {
      #       & $signtool sign /f $env:CERT_PATH /p "${{ secrets.WINDOWS_CERT_PASSWORD }}" /fd SHA256 /td SHA256 /tr $timestamp "$($f.FullName)"
      #     }

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            app/src-tauri/target/*/release/bundle/**/*
          generate_release_notes: false
          body: ${{ steps.changelog.outputs.clean_changelog }}
          fail_on_unmatched_files: true
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
